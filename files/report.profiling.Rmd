---
title: "BFAST Profiling Results"
output:
  html_document:
    toc: true
    theme: united
    self_contained: true
---

```{r,results='hide',echo=FALSE}
buildProfileGraph <- function(profobj, threshold = 2.5) {
  invisible(require(igraph))
  edges = data.frame(from=NULL,to=NULL,weight=NULL)
  vertices = data.frame(name=NULL,label=NULL,weight=NULL)
  for (i in 1:length(profobj$time)) {
    for (j in 1:nrow(profobj$ref[[i]])) {
      # if vertex with name profobj$ref[[i]]$f[i] does not exist, create it
      vname = paste(profobj$ref[[i]]$f[1:j],collapse="/")
      vs = which(vertices$name == vname)
      if (length(vs)==0) {
        vertices = rbind(vertices,data.frame(name=vname, label=profobj$ref[[i]]$f[j], weight=profobj$time[i], stringsAsFactors = FALSE))
      }
      else if (length(vs)==1) {
        vertices$weight[vs] = vertices$weight[vs] + profobj$time[i]
      }
      else {
        warning("duplicate vertices")
        next
      }
    }
    if (nrow(profobj$ref[[i]]) > 1) {
      for (j in 1:(nrow(profobj$ref[[i]])-1)) {
        vname0 = paste(profobj$ref[[i]]$f[1:j],collapse="/")
        vname1 = paste(profobj$ref[[i]]$f[1:(j+1)],collapse="/")
        es = which(edges$from ==vname0 & edges$to == vname1)
        # if edge from profobj$ref[[i]]$f[j] to profobj$ref[[i]]$f[j+1] does not exist, create it
        if (length(es) == 0) {
          edges = rbind(edges,data.frame(from=vname0, to=vname1, weight=profobj$time[i]),stringsAsFactors=FALSE) # TODO: add weight
        }
        else if (length(es) == 1) {
          # add weight profobj$time[i]...
          edges$weight[es] =edges$weight[es] + profobj$time[i] # TODO: add proper weight
        }
        else {
          warning("duplicate edges")
          next
        }
      }
    }
  }
  vertices$reltime =round(100*vertices$weight / sum(profobj$time),digits = 1)
  vertices =vertices[which(vertices$reltime >= threshold),]
  edges = edges[which(edges$from %in% vertices$name & edges$to %in% vertices$name),]
  df.g <- graph.data.frame(d = edges, directed = T,vertices = vertices)
  V(df.g)$label = paste(V(df.g)$label,"\n", V(df.g)$reltime , "%", sep="")
  return(df.g)
}
``` 




This document compares CRAN versions of the R packages [bfast](https://cran.r-project.org/web/packages/bfast/index.html) and [strucchange](https://cran.r-project.org/web/packages/strucchange/index.html) with implemented [modifications](https://github.com/appelmar/bfast) in terms of identifying bottlenecks. It is automatically generated by applying the same functions among the package versions and using the [lineprof](https://github.com/hadley/lineprof) R package on all functions. Below, two tables for all test functions (as in benchmark.R) present profiling results of the original CRAN version and the modifications respectively. 


## Tables of most expensive function calls

```{r, echo=FALSE, results='asis'}
library(knitr)
bfast.old.env = new.env()
bfast.new.env = new.env()
load("/opt/results/profiling.results.old.rda", envir = bfast.old.env)
load("/opt/results/profiling.results.new.rda", envir = bfast.new.env)

for (fname in names(bfast.old.env$results)) {
  # print bottlenecks old vs new, show only functions with more than or equal to 2% of the total computation times
  cat(paste("### Function:",fname))
  cat("\n")
  rownames(bfast.old.env$results[[fname]]) <- NULL
  rownames(bfast.new.env$results[[fname]]) <- NULL
  print(kable(bfast.old.env$results[[fname]][which(bfast.old.env$results[[fname]]$rel_time >= 0.02),],format="markdown"))
  cat("\n")
  print(kable(bfast.new.env$results[[fname]][which(bfast.new.env$results[[fname]]$rel_time >= 0.02),],format="markdown"))
  cat("\n")
}
```


## Graphs of most expensive function calls 
```{r, echo=FALSE}
library(knitr)
bfast.old.env = new.env()
bfast.new.env = new.env()
load("/opt/results/profiling.results.old.rda", envir = bfast.old.env)
load("/opt/results/profiling.results.new.rda", envir = bfast.new.env)

for (fname in names(bfast.old.env$results_prof)) {
 par(mar=c(0,0,1,0))
 graph = buildProfileGraph(bfast.old.env$results_prof[[fname]])
 plot(graph,main=paste("Function: ", fname, " (orig.)", sep=""),layout=layout_(graph,as_tree()), vertex.size = 6,vertex.frame.color="gray", vertex.label.cex = 0.3,vertex.label.color="black", vertex.color="gray", edge.width=0.7, edge.arrow.width=0.0)

 graph = buildProfileGraph(bfast.new.env$results_prof[[fname]])
 plot(graph,main=paste("Function: ", fname, " (mod.)", sep=""),layout=layout_(graph,as_tree()), vertex.size = 6,vertex.frame.color="gray", vertex.label.cex = 0.3,vertex.label.color="black", vertex.color="gray", edge.width=0.7, edge.arrow.width=0.0)
}
```


---

```{r, echo=FALSE, results='hide'}
str.strucchange.mod = "strucchange:local"
str.bfast.orig = "bfast:cran"
str.bfast.mod = "bfast:local"
str.strucchange.orig = "strucchange:cran"

if (all(file.exists(c("/opt/git-bfast-orig.txt","/opt/git-bfast-mod.txt","/opt/git-strucchange-orig.txt", "/opt/git-strucchange-mod.txt"))))
{
  gitcommit.bfast.orig = readLines("/opt/git-bfast-orig.txt")
  commiturl.bfast.orig = paste("https://github.com/appelmar/bfast/commit/", gitcommit.bfast.orig  , sep="")
  str.bfast.orig  = paste("[bfast:", gitcommit.bfast.orig , "](", commiturl.bfast.orig , ")", sep="")
  
  gitcommit.bfast.mod  = readLines("/opt/git-bfast-mod.txt")
  commiturl.bfast.mod  = paste("https://github.com/appelmar/bfast/commit/", gitcommit.bfast.mod  , sep="")
  str.bfast.mod  = paste("[bfast:", gitcommit.bfast.mod , "](", commiturl.bfast.mod , ")", sep="")
  
  gitcommit.strucchange.orig = readLines("/opt/git-strucchange-orig.txt")
  commiturl.strucchange.orig   = paste("https://github.com/appelmar/strucchange/commit/", gitcommit.strucchange.orig , sep="")
  str.strucchange.orig   = paste("[strucchange:", gitcommit.strucchange.orig  , "](", commiturl.strucchange.orig  , ")", sep="")
  
  gitcommit.strucchange.mod = readLines("/opt/git-strucchange-mod.txt")
  commiturl.strucchange.mod   = paste("https://github.com/appelmar/strucchange/commit/", gitcommit.strucchange.mod , sep="")
  str.strucchange.mod   = paste("[strucchange:", gitcommit.strucchange.mod  , "](", commiturl.strucchange.mod  , ")", sep="")
}
```

_This report has been generated on `r Sys.time()` and compares the reference package versions from `r str.strucchange.orig` and  `r str.bfast.orig` with modified versions from `r str.strucchange.mod` and  `r str.bfast.mod`._




